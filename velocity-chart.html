<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Velocity Chart</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      margin: 0;
      padding: 8px;
      background: #f0f0f0;
    }
    .chart-wrapper {
      display: flex;
      max-width: 1100px;
      border: 2px solid #000;
      border-radius: 12px;
      overflow: hidden;
      background: #000;
      padding: 8px;
    }
    .left-panel {
      background: #000;
      padding: 0;
      min-width: 260px;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    .chart-title-wrap {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      padding-top: 0.7rem;
    }
    .chart-title-wrap .chart-title {
      flex: 1;
    }
    .chart-title-wrap img {
      margin-left: auto;
    }
    .chart-title-wrap img {
      display: block;
      width: 20px;
      height: 20px;
      flex-shrink: 0;
      margin-right: 0.75rem;
    }
    .chart-title {
      color: #fff;
      font-size: 1.25rem;
      font-weight: 700;
      margin: 0;
    }
    .contributor-section {
      display: flex;
      flex-direction: column;
      gap: 6.5px;
      margin-top: 0.05rem;
    }
    #contributor-rows {
      display: flex;
      flex-direction: column;
      gap: 6.5px;
    }
    .contributor-header-row {
      display: flex;
      gap: 6.5px;
      align-items: stretch;
    }
    .contributor-header {
      background: #09757A;
      color: #fff;
      font-weight: 600;
      font-size: 13px;
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      flex: 1;
      min-width: 0;
      max-width: 140px;
      display: flex;
      align-items: center;
    }
    .low-high-header {
      background: #09757A;
      color: #fff;
      font-weight: 600;
      font-size: 13px;
      padding: 0.5rem 0.6rem;
      border-radius: 8px;
      width: 48px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .contributor-row {
      display: flex;
      gap: 6.5px;
      align-items: stretch;
    }
    .contributor-input {
      background: #1D1D1D;
      color: #fff;
      border: none;
      padding: 0.5rem 0.4rem;
      border-radius: 8px;
      flex: 1;
      min-width: 0;
      max-width: 140px;
      font-size: 14px;
    }
    .contributor-input::placeholder {
      color: #888;
    }
    .contributor-input:focus {
      outline: 2px solid #fff;
      outline-offset: -2px;
    }
    .low-high-input {
      background: #1D1D1D;
      color: #fff;
      border: none;
      padding: 0.5rem 0.4rem;
      border-radius: 8px;
      width: 48px;
      text-align: center;
      font-size: 14px;
    }
    .low-high-input:focus {
      outline: 2px solid #fff;
      outline-offset: -2px;
    }
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      background: #D8EFEF;
    }
    .multiplier-section {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    .multiplier-label {
      background: #fff;
      color: #000;
      font-weight: 600;
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      font-size: 13px;
      white-space: nowrap;
    }
    .multiplier-value {
      background: #fff;
      color: #000;
      border: none;
      padding: 0.5rem 0.6rem;
      border-radius: 8px;
      width: 52px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
    }
    .multiplier-value:focus {
      outline: 2px solid #09757A;
      outline-offset: -2px;
    }
    .teal-wrapper {
      flex: 1;
      background: #D8EFEF;
      padding: 8px;
      border-radius: 10px;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }
    .right-panel {
      flex: 1;
      background: transparent;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    .month-nav {
      display: flex;
      align-items: center;
      gap: 0.05rem;
      flex: 1;
      min-width: 0;
    }
    .sprint-nav-btn {
      background: transparent;
      border: none;
      color: #000;
      font-size: 1.5rem;
      line-height: 1;
      padding: 0.25rem 0.35rem;
      cursor: pointer;
      border-radius: 4px;
    }
    .sprint-nav-btn:hover {
      background: rgba(0,0,0,0.08);
    }
    .sprint-nav-calendar {
      font-size: 1.1rem;
    }
    .sprint-nav-calendar img {
      display: block;
      margin-top: -1px;
    }
    .month-header {
      background: #D8EFEF;
      color: #000;
      font-weight: 600;
      padding: 0.4rem 0.75rem;
      padding-left: 9px;
      font-size: 18px;
      flex: 0 1 auto;
      min-width: 0;
      display: flex;
      align-items: center;
      text-align: left;
    }
    .white-content {
      flex: 0 0 auto;
      background: #fff;
      border-radius: 5px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 3px;
      margin-top: 8px;
    }
    .grid-table thead th {
      background: #09757A;
      color: #fff;
      padding: 0.5rem 0.4rem;
      border-radius: 8px;
      text-align: center;
      font-size: 13px;
      font-weight: 500;
      width: 1%;
    }
    .grid-table thead th.empty {
      color: #fff;
    }
    .grid-table thead th:focus {
      outline: 2px solid #fff;
      outline-offset: -2px;
    }
    .multiplier-label:focus {
      outline: 2px solid #09757A;
      outline-offset: -2px;
    }
    .month-header:focus {
      outline: none;
    }
    .grid-wrapper {
      flex: 0 0 auto;
      padding: 0;
      overflow: auto;
    }
    .grid-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 6px;
      table-layout: fixed;
    }
    .grid-table td {
      background: #F0EFEF;
      border-radius: 8px;
      padding: 0.5rem 0.4rem;
      min-width: 56px;
      width: 1%;
      text-align: center;
      font-size: 14px;
      cursor: pointer;
    }
    .grid-table td:focus {
      outline: none;
    }
    .grid-table td.special {
      background: #add8e6;
    }
    .grid-table td.island {
      background: #D8EFEF;
      font-size: 11px;
    }
    .contributor-name-cell {
      background: #2d2d2d;
      color: #fff;
      border: none;
      padding: 0.5rem 0.75rem;
      width: 100%;
      font-size: 14px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="chart-wrapper" id="chart-wrapper">
    <div class="left-panel">
      <div class="chart-title-wrap">
        <h1 class="chart-title">Velocity Chart</h1>
        <img src="plus.svg" alt="" width="20" height="20">
      </div>
      <div class="contributor-section">
        <div class="contributor-header-row">
          <span class="contributor-header">Contributor</span>
          <span class="low-high-header">Low</span>
          <span class="low-high-header">High</span>
        </div>
        <div id="contributor-rows"></div>
      </div>
    </div>
    <div class="teal-wrapper">
      <div class="right-panel">
        <div class="top-bar">
          <div class="month-nav">
            <button type="button" class="sprint-nav-btn sprint-nav-calendar" id="sprint-today" aria-label="Go to current sprint"><img src="calendar.svg" alt="" width="20" height="20"></button>
            <span class="month-header" id="month-header" contenteditable="true">February 2026</span>
            <button type="button" class="sprint-nav-btn" id="sprint-prev" aria-label="Previous sprint">‹</button>
            <button type="button" class="sprint-nav-btn" id="sprint-next" aria-label="Next sprint">›</button>
          </div>
          <div class="multiplier-section">
            <span class="multiplier-label" id="multiplier-label" contenteditable="true">Points Multiplier (Low)</span>
            <input type="text" class="multiplier-value" id="multiplier-input" value="0.6" />
          </div>
        </div>
        <div class="white-content">
          <div class="grid-wrapper">
            <table class="grid-table" id="grid-table">
              <thead><tr id="dates-row"></tr></thead>
              <tbody id="grid-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    var STORAGE_KEY = 'velocityChartData';
    var NUM_COLUMNS = 10;
    var DEFAULT_DATES = ['2/17/26', '2/18/26', '', '', '', '', '', '', '', ''];
    var DEFAULT_ROWS = [
      { name: '', low: '', high: '', points: ['', '', '', '', '', '', '', '', '', ''], pointSpecials: [] },
      { name: '', low: '', high: '', points: ['', '', '', '', '', '', '', '', '', ''], pointSpecials: [] },
      { name: '', low: '', high: '', points: ['', '', '', '', '', '', '', '', '', ''], pointSpecials: [] }
    ];

    // Wellness days: apply to every contributor regardless of country
    var WELLNESS_DAYS = ['2026-03-13', '2026-05-15', '2026-08-14', '2026-10-09'];

    var HOLIDAYS_BY_PERSON = [
      { names: ['sayan', 'raul', 'raúl'], dates: ['2026-01-01','2026-01-12','2026-03-13','2026-03-23','2026-04-02','2026-04-03','2026-05-01','2026-05-15','2026-05-18','2026-06-08','2026-06-15','2026-06-29','2026-07-20','2026-08-07','2026-08-14','2026-08-17','2026-10-09','2026-10-12','2026-11-02','2026-11-16','2026-12-08','2026-12-25'] },
      { names: ['nadia'], dates: ['2026-01-01','2026-02-16','2026-03-13','2026-04-03','2026-05-15','2026-05-18','2026-07-01','2026-08-03','2026-08-14','2026-09-07','2026-09-30','2026-10-09','2026-10-12','2026-12-25','2026-12-28'] },
      { names: ['shriya', 'eileen', 'arissa', 'grace', 'alexis'], dates: ['2026-01-01','2026-01-19','2026-03-13','2026-05-15','2026-05-25','2026-06-19','2026-07-03','2026-08-14','2026-09-07','2026-10-09','2026-11-11','2026-11-26','2026-11-27','2026-12-25'] }
    ];

    function gridDateToISO(dateStr) {
      if (!dateStr || !/^\d{1,2}\/\d{1,2}\/\d{2}$/.test(dateStr)) return '';
      var parts = dateStr.split('/');
      var m = parseInt(parts[0], 10);
      var d = parseInt(parts[1], 10);
      var y2 = parseInt(parts[2], 10);
      var year = y2 < 50 ? 2000 + y2 : 1900 + y2;
      return year + '-' + (m < 10 ? '0' : '') + m + '-' + (d < 10 ? '0' : '') + d;
    }

    function getHolidayDatesForName(name) {
      if (!name || !name.trim()) return [];
      var lower = name.trim().toLowerCase();
      for (var i = 0; i < HOLIDAYS_BY_PERSON.length; i++) {
        for (var j = 0; j < HOLIDAYS_BY_PERSON[i].names.length; j++) {
          if (lower.indexOf(HOLIDAYS_BY_PERSON[i].names[j]) !== -1) return HOLIDAYS_BY_PERSON[i].dates;
        }
      }
      return [];
    }

    function isHolidayForPerson(dateStr, name) {
      var iso = gridDateToISO(dateStr);
      if (!iso) return false;
      if (WELLNESS_DAYS.indexOf(iso) !== -1) return true;
      var holidays = getHolidayDatesForName(name);
      return holidays.indexOf(iso) !== -1;
    }

    function getSprintStartTuesday(d) {
      var date = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      var day = date.getDay();
      var daysUntilTuesday = (2 - day + 7) % 7;
      date.setDate(date.getDate() + daysUntilTuesday);
      return date;
    }

    function getNextWorkDay(d) {
      var next = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      next.setDate(next.getDate() + 1);
      while (next.getDay() === 0 || next.getDay() === 6) {
        next.setDate(next.getDate() + 1);
      }
      return next;
    }

    function formatDateForDisplay(d) {
      var month = d.getMonth() + 1;
      var day = d.getDate();
      var year = String(d.getFullYear()).slice(-2);
      return month + '/' + day + '/' + year;
    }

    var SPRINT_CALENDAR_DAYS = 14;

    function getSprintDatesForOffset(offset) {
      var baseStart = getSprintStartTuesday(new Date());
      var start = new Date(baseStart.getFullYear(), baseStart.getMonth(), baseStart.getDate());
      start.setDate(start.getDate() + offset * SPRINT_CALENDAR_DAYS);
      var dates = [];
      var d = new Date(start.getFullYear(), start.getMonth(), start.getDate());
      for (var i = 0; i < NUM_COLUMNS; i++) {
        dates.push(formatDateForDisplay(d));
        d = getNextWorkDay(d);
      }
      return dates;
    }

    function getSprintMonthLabelForOffset(offset) {
      var dates = getSprintDatesForOffset(offset);
      if (dates.length === 0) return 'February 2026';
      var first = dates[0].split('/');
      var last = dates[dates.length - 1].split('/');
      var monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      var m1 = parseInt(first[0], 10) - 1;
      var m2 = parseInt(last[0], 10) - 1;
      var y1 = 2000 + parseInt(first[2], 10);
      var y2 = 2000 + parseInt(last[2], 10);
      if (m1 === m2 && y1 === y2) return monthNames[m1] + ' ' + y1;
      return monthNames[m1] + ' ' + y1 + ' – ' + monthNames[m2] + ' ' + y2;
    }

    function getSprintDates() {
      return getSprintDatesForOffset(0);
    }

    function getSprintMonthLabel() {
      return getSprintMonthLabelForOffset(0);
    }

    var sprintOffset = 0;

    function updateSprintDisplay() {
      var dates = getSprintDatesForOffset(sprintOffset);
      var monthLabel = getSprintMonthLabelForOffset(sprintOffset);
      document.getElementById('month-header').textContent = monthLabel;
      var dateCells = document.querySelectorAll('#dates-row th');
      for (var i = 0; i < dateCells.length && i < dates.length; i++) {
        dateCells[i].textContent = dates[i];
        dateCells[i].className = dates[i] ? '' : 'empty';
      }
      // Re-apply holiday logic for this sprint's dates so islands show correctly
      var gridRows = document.querySelectorAll('#grid-body tr');
      var rowContainers = document.querySelectorAll('#contributor-rows .contributor-row');
      for (var r = 0; r < gridRows.length; r++) {
        var name = '';
        if (rowContainers[r]) {
          var nameEl = rowContainers[r].querySelector('.contributor-input');
          if (nameEl) name = nameEl.value.trim();
        }
        var cells = gridRows[r].querySelectorAll('td');
        for (var c = 0; c < cells.length && c < dates.length; c++) {
          var dateStr = dates[c];
          var isHoliday = isHolidayForPerson(dateStr, name);
          var td = cells[c];
          if (isHoliday) {
            td.textContent = '\u{1F334}';
            td.classList.add('island');
          } else {
            var cur = td.textContent.trim();
            if (cur === '\u{1F334}' || cur === '') td.textContent = '2';
            td.classList.remove('island');
          }
        }
      }
      updateLowFromPoints();
      saveChartData();
    }

    function getStoredOrDefault() {
      try {
        var raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          var data = JSON.parse(raw);
          if (data.rows && data.rows.length) {
            if (!data.month) data.month = 'February 2026';
            if (data.dates && data.dates.length > NUM_COLUMNS) data.dates = data.dates.slice(0, NUM_COLUMNS);
            return data;
          }
        }
      } catch (e) {}
      return {
        month: 'February 2026',
        dates: DEFAULT_DATES.slice(),
        rows: DEFAULT_ROWS.map(function(r) {
          return {
            name: r.name,
            low: r.low,
            high: r.high,
            points: (r.points || []).slice(),
            pointSpecials: (r.pointSpecials || []).slice()
          };
        }),
        multiplier: '0.6'
      };
    }

    function getChartData() {
      var data = {
        month: document.getElementById('month-header').textContent.trim(),
        dates: [],
        rows: [],
        multiplier: document.getElementById('multiplier-input').value.trim()
      };
      var dateCells = document.querySelectorAll('#dates-row th');
      for (var i = 0; i < dateCells.length; i++)
        data.dates.push(dateCells[i].textContent.trim());
      var rowContainers = document.querySelectorAll('#contributor-rows .contributor-row');
      var gridRows = document.querySelectorAll('#grid-body tr');
      for (var r = 0; r < rowContainers.length; r++) {
        var nameEl = rowContainers[r].querySelector('.contributor-input');
        var lowEl = rowContainers[r].querySelector('.low-high-input.low');
        var highEl = rowContainers[r].querySelector('.low-high-input.high');
        var points = [];
        var pointSpecials = [];
        if (gridRows[r]) {
          var cells = gridRows[r].querySelectorAll('td');
          for (var c = 0; c < cells.length; c++) {
            points.push(cells[c].textContent.trim());
            pointSpecials.push(cells[c].classList.contains('special'));
          }
        }
        data.rows.push({
          name: nameEl ? nameEl.value.trim() : '',
          low: lowEl ? lowEl.value.trim() : '',
          high: highEl ? highEl.value.trim() : '',
          points: points,
          pointSpecials: pointSpecials
        });
      }
      return data;
    }

    function saveChartData() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(getChartData()));
      } catch (e) {}
    }

    var HIGH_MULTIPLIER = 0.8;

    function updateLowFromPoints() {
      var multiplier = parseFloat(document.getElementById('multiplier-input').value, 10) || 0.6;
      var gridRows = document.querySelectorAll('#grid-body tr');
      var rowContainers = document.querySelectorAll('#contributor-rows .contributor-row');
      for (var r = 0; r < gridRows.length; r++) {
        var cells = gridRows[r].querySelectorAll('td');
        var sum = 0;
        for (var c = 0; c < cells.length; c++) {
          var val = parseFloat(cells[c].textContent.trim(), 10);
          if (!isNaN(val)) sum += val;
        }
        var low = Math.round(sum * multiplier);
        var high = Math.round(sum * HIGH_MULTIPLIER);
        if (rowContainers[r]) {
          var lowEl = rowContainers[r].querySelector('.low-high-input.low');
          var highEl = rowContainers[r].querySelector('.low-high-input.high');
          if (lowEl) lowEl.value = low;
          if (highEl) highEl.value = high;
        }
      }
    }

    function render(data) {
      var r, c, row, cell, tr, td;
      var rowsContainer = document.getElementById('contributor-rows');
      var datesRow = document.getElementById('dates-row');
      var gridBody = document.getElementById('grid-body');
      var monthHeader = document.getElementById('month-header');

      var dates = getSprintDates();
      monthHeader.textContent = getSprintMonthLabel();
      datesRow.innerHTML = '';
      for (c = 0; c < NUM_COLUMNS; c++) {
        cell = document.createElement('th');
        cell.className = dates[c] ? '' : 'empty';
        cell.contentEditable = 'true';
        cell.textContent = dates[c] || '';
        cell.dataset.col = c;
        datesRow.appendChild(cell);
      }

      rowsContainer.innerHTML = '';
      gridBody.innerHTML = '';
      var rowCount = (data.rows && data.rows.length) ? data.rows.length : 3;
      var rows = data.rows || [];
      for (r = 0; r < rowCount; r++) {
        var rec = rows[r] || { name: '', low: '', high: '', points: [], pointSpecials: [] };
        row = document.createElement('div');
        row.className = 'contributor-row';
        row.innerHTML =
          '<input type="text" class="contributor-input" placeholder="Name" value="' + escapeHtml(rec.name) + '" data-row="' + r + '" />' +
          '<input type="text" class="low-high-input low" placeholder="—" value="' + escapeHtml(rec.low) + '" data-row="' + r + '" />' +
          '<input type="text" class="low-high-input high" placeholder="—" value="' + escapeHtml(rec.high) + '" data-row="' + r + '" />';
        rowsContainer.appendChild(row);

        tr = document.createElement('tr');
        var points = (rec.points || []).slice(0, NUM_COLUMNS);
        var specials = (rec.pointSpecials || []).slice(0, NUM_COLUMNS);
        while (points.length < NUM_COLUMNS) points.push('');
        while (specials.length < NUM_COLUMNS) specials.push(false);
        for (c = 0; c < NUM_COLUMNS; c++) {
          td = document.createElement('td');
          var dateStr = dates[c];
          var isHoliday = isHolidayForPerson(dateStr, rec.name);
          var pt;
          if (isHoliday) {
            pt = '\u{1F334}';
          } else {
            pt = (points[c] && points[c] !== '\u{1F334}') ? points[c] : '2';
          }
          td.textContent = pt;
          if (pt === '\u{1F334}') td.classList.add('island');
          if (specials[c]) td.classList.add('special');
          td.dataset.row = r;
          td.dataset.col = c;
          tr.appendChild(td);
        }
        gridBody.appendChild(tr);
      }

      document.getElementById('multiplier-input').value = data.multiplier != null ? data.multiplier : '0.6';
      updateLowFromPoints();
    }

    function escapeHtml(s) {
      if (s == null) return '';
      var div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML.replace(/"/g, '&quot;');
    }

    function attachListeners() {
      function onEdit() { saveChartData(); }
      function onPointsOrMultiplierEdit() {
        updateLowFromPoints();
        saveChartData();
      }
      document.querySelectorAll('.contributor-input, .low-high-input').forEach(function(el) {
        el.addEventListener('input', onEdit);
        el.addEventListener('change', onEdit);
      });
      document.getElementById('multiplier-input').addEventListener('input', onPointsOrMultiplierEdit);
      document.getElementById('multiplier-input').addEventListener('change', onPointsOrMultiplierEdit);
      document.querySelectorAll('#grid-body td').forEach(function(td) {
        td.addEventListener('click', function(e) {
          if (this.classList.contains('island')) {
            this.textContent = '2';
            this.classList.remove('island');
          } else {
            this.textContent = '\u{1F334}';
            this.classList.add('island');
          }
          updateLowFromPoints();
          saveChartData();
        });
      });
      document.querySelectorAll('#dates-row th').forEach(function(cell) {
        cell.addEventListener('input', onEdit);
        cell.addEventListener('blur', onEdit);
      });
      document.getElementById('month-header').addEventListener('input', onEdit);
      document.getElementById('month-header').addEventListener('blur', onEdit);
      document.getElementById('sprint-prev').addEventListener('click', function() {
        sprintOffset--;
        updateSprintDisplay();
      });
      document.getElementById('sprint-next').addEventListener('click', function() {
        sprintOffset++;
        updateSprintDisplay();
      });
      document.getElementById('sprint-today').addEventListener('click', function() {
        sprintOffset = 0;
        updateSprintDisplay();
      });
    }

    document.addEventListener('DOMContentLoaded', function() {
      var data = getStoredOrDefault();
      if (data.rows && data.rows.length > 3) {
        while (data.rows.length > 0 && !data.rows[data.rows.length - 1].name && data.rows.length > 3)
          data.rows.pop();
      }
      render(data);
      attachListeners();
    });
  </script>
</body>
</html>
